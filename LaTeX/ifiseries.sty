\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ifiseries}
\RequirePackage{kvoptions}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Options and their defaults

\DeclareBoolOption[true]{natbib}
\DeclareBoolOption[false]{babelbib}
\DeclareBoolOption[false]{biblatex}
\DeclareStringOption[sort,authoryear,round]{natbibOptions}
\DeclareStringOption[alphabetic]{biblatexstyle}
\DeclareStringOption[minalphanames=3,maxcitenames=4,maxbibnames=10,autolang=other]{biblatexOptions}
\DeclareStringOption[]{biblatexAdditionalOptions}
\DeclareStringOption[bibtex]{biblatexBackend}
\DeclareStringOption[]{bibresource}
\DeclareStringOption[ngerman,english]{babelOptions}
\DeclareStringOption[]{variorefOptions}
\DeclareBoolOption[true]{algorithm}
\DeclareStringOption[linesnumbered,ruled,vlined]{algorithmOptions}
\DeclareStringOption[plainnat]{bibliographystyle} % only for bibtex, not biblatex
\DeclareStringOption[utf8]{inputencOptions}
\DeclareBoolOption[true]{tikz}
\DeclareStringOption[1.3]{pgfplotscompat}
\DeclareBoolOption[true]{algorithmForwardCompatibility}
\DeclareBoolOption[true]{algorithmBackwardCompatibility}
\DeclareStringOption[acronym]{acronymPackage}
\DeclareStringOption[smaller,nohyperlinks,printonlyused]{acronymOptions}
\DeclareStringOption[4em]{acroLabelWidth}
\DeclareStringOption[]{hyphenatOptions}
\DeclareStringOption[caption=false,font=footnotesize]{subfigOptions}
\DeclareStringOption[]{theorems}
\DeclareStringOption[]{theoremsplainfont}
\DeclareStringOption[]{theoremsremarkfont}
\DeclareStringOption[Bibliography]{refname}
\DeclareStringOption[black]{hypercolor}
\DeclareBoolOption[false]{dottednumbers}
\DeclareStringOption[english]{language}
\DeclareBoolOption[true]{runningtitle}
\DeclareBoolOption[true]{includehead}
\DeclareBoolOption[true]{frenchspacing}
\DeclareBoolOption[false]{onemargin}
\DeclareStringOption[]{margincontrol}
\DeclareBoolOption[true]{mathabx}
\DeclareBoolOption[false]{txfonts}
\DeclareBoolOption[true]{xcolor}

\DeclareBoolOption[true]{layout}
\DeclareBoolOption[true]{pagelayout}
\DeclareStringOption[ustrade]{paper}
\DeclareStringOption[]{paperwidth}
\DeclareStringOption[]{paperheight}
\DeclareStringOption[0mm]{bindingcorrection}
\DeclareStringOption[.25]{halfparskipfill}
\DeclareBoolOption[false]{halfparskip}
\DeclareStringOption[Palatino]{font}
\DeclareStringOption[ppl]{PalatinoSC}
\DeclareStringOption[12]{marginfrac}
\DeclareStringOption[floatrow]{figure}
\DeclareStringOption[]{compact}
\DeclareStringOption[1.5]{headsepmult}
\DeclareStringOption[3]{footskipmult}
\DeclareBoolOption[false]{leftmarkright}
\if@twoside
\DeclareBoolOption[false]{hcenter}
\else
\DeclareBoolOption[true]{hcenter}
\fi
\@ifclassloaded{book}%
{\DeclareStringOption[section]{theoremswithin}}%
{\DeclareStringOption[subsection]{theoremswithin}}

\DeclareBoolOption[false]{largepaper}

\ProcessKeyvalOptions*

\RequirePackage{etoolbox}
\RequirePackage{xifthen}
\RequirePackage{expl3}
\RequirePackage{xparse}

\ififiseries@largepaper
  \let\ifiseries@marginfrac\@undefined%
  \let\ifiseries@headsepmult\@undefined%
  \let\ifiseries@footskipmult\@undefined%
  \DeclareStringOption[9]{marginfrac}%
  \DeclareStringOption[2]{headsepmult}%
  \DeclareStringOption[3.5]{footskipmult}%
\fi

\ExplSyntaxOn
\str_case:onF{\ifiseries@language}{
  {english} {\relax}
  {german} {
      \let\ifiseries@babelOptions\@undefined%
      \let\ifiseries@variorefOptions\@undefined%
      \let\ifiseries@refname\@undefined%
      \let\ifiseries@dottednumberstrue\@undefined%
      \let\ifiseries@dottednumbersfalse\@undefined%
      \let\ififiseries@dottednumbers\@undefined%
      \DeclareStringOption[english,ngerman]{babelOptions}%
      \DeclareStringOption[ngerman]{variorefOptions}%
      \DeclareStringOption[Bibliografie]{refname}%
      \DeclareBoolOption[true]{dottednumbers}%
      }
}{\PackageError{ifiseries}{Unsupported~language:~\ifiseries@language}\@ehc}
\ExplSyntaxOff

\ifthenelse{\equal{\ifiseries@theorems}{numberslast}}%
{\let\ifiseries@theoremswithin\@undefined%
\@ifclassloaded{book}%
{\DeclareStringOption[chapter]{theoremswithin}}%
{\DeclareStringOption[section]{theoremswithin}}}%
{}

\ProcessKeyvalOptions*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Packages with no or minimal influence on the main layout

\RequirePackage[\ifiseries@inputencOptions]{inputenc}
\RequirePackage[T1]{fontenc}
\ififiseries@xcolor
\@ifclassloaded{beamer}{}{\@ifclassloaded{dinbrief}{}{\RequirePackage[rgb,svgnames]{xcolor}}}
\fi
\RequirePackage[\ifiseries@babelOptions]{babel}

% To avoid a possible error with TeXLive 2015 (at least on Mac), we
% include floatrow as early as possible.
\ExplSyntaxOn
\str_case:onF{\ifiseries@figure}{
  {} {\relax}
  {floatrow} {\RequirePackage{floatrow}\DeclareCaptionSubType[alph]{figure}}
  {subfig} {\RequirePackage[\ifiseries@subfigOptions]{subfig}\RequirePackage{sidecap}\sidecaptionvpos{figure}{t}}
}{\PackageError{ifiseries}{Unknown~figure~system:~\ifiseries@figure}\@ehc}
\ExplSyntaxOff

\RequirePackage{amsmath}
\ififiseries@mathabx
  \RequirePackage[matha]{mathabx}
  %%% see http://tex.stackexchange.com/questions/271767/size-substitutions-with-amsmath-mathabx-mathpazo/281443#281443
  \DeclareFontShape{U}{matha}{m}{n}{
    <-6> matha5
    <6-7> matha6
    <7-8> matha7
    <8-9> matha8
    <9-10> matha9
    <10-12> matha10
    <12-> matha12
    }{}
  %%%
\fi
\RequirePackage{amssymb}
\RequirePackage{amsfonts}
\RequirePackage{amstext}
\RequirePackage{mathtools}
\RequirePackage{nicefrac}
\RequirePackage{graphicx}
\RequirePackage{grffile}
\RequirePackage{eso-pic}
\RequirePackage{listings}
\RequirePackage{booktabs}
\RequirePackage{multicol}
\RequirePackage{multirow}
\RequirePackage{varwidth}
\RequirePackage[autolanguage,np]{numprint}
\RequirePackage{units}
\RequirePackage[babel=true]{csquotes}
\ififiseries@natbib\RequirePackage[\ifiseries@natbibOptions]{natbib}\fi
\ififiseries@babelbib\RequirePackage{babelbib}\fi
\ififiseries@biblatex
  \RequirePackage[style=\ifiseries@biblatexstyle,\ifiseries@biblatexOptions,\ifiseries@biblatexAdditionalOptions,backend=\ifiseries@biblatexBackend]{biblatex}%
  \ifdefempty{\ifiseries@bibresource}{}{\addbibresource{\ifiseries@bibresource}}%
  \ExplSyntaxOn%
  \str_case:onF{\ifiseries@language}{%
    {english} {%
      \DeclareFieldFormat{realtitlecase}{\MakeSentenceCase*{#1}}%
      \DeclareFieldFormat[incollection]{title}{\enquote{#1}}%
    }}{}%
  \ExplSyntaxOff%
  \defbibheading{section}[\refname]{\section{#1}}%
  %% cf. texmf-dist/tex/latex/biblatex/biblatex.def
  \renewbibmacro*{title}{%
    \ifboolexpr{
      test {\iffieldundef{title}}
      and
      test {\iffieldundef{subtitle}}
    }
      {}
      {\printtext[title]{%
         \printfield[realtitlecase]{title}%
         \setunit{\subtitlepunct}%
         \printfield[realtitlecase]{subtitle}}%
       \newunit}%
    \printfield{titleaddon}}%
    %%
\else
  \bibliographystyle{\ifiseries@bibliographystyle}%
  \RequirePackage{bibentry}%
\fi
\RequirePackage[\ifiseries@variorefOptions]{varioref}
\RequirePackage{url}
\RequirePackage{dsfont}
\RequirePackage{bbding}
\RequirePackage{pifont}
\ififiseries@txfonts\RequirePackage{txfonts}\fi
\RequirePackage{stmaryrd}
\RequirePackage{calc}
\RequirePackage{blindtext}
\RequirePackage{setspace}
\RequirePackage{relsize}
\ififiseries@algorithm
\RequirePackage[\ifiseries@algorithmOptions]{algorithm2e}
\ififiseries@algorithmForwardCompatibility
  \ifthenelse{\isundefined{\DontPrintSemicolon}}{\newcommand*{\DontPrintSemicolon}{\dontprintsemicolon}}{}
  \ifthenelse{\isundefined{\SetAlgoVlined}}{\newcommand*{\SetAlgoVlined}{\SetVline}}{}
  \ifthenelse{\isundefined{\SetAlgoNoLine}}{\newcommand*{\SetAlgoNoLine}{\SetNoline}}{}
\fi
\ififiseries@algorithmBackwardCompatibility
  \ifthenelse{\isundefined{\RestyleAlgo}}{\let\RestyleAlgo\restylealgo}
\fi\fi
\RequirePackage[compatibility=false]{caption} % compatibility switched off for hyperref
\RequirePackage{bookmark}
\RequirePackage{hyperref}
\hypersetup{%
  final=true,%
  colorlinks=true,%
  linkcolor=\ifiseries@hypercolor,%
  citecolor=\ifiseries@hypercolor,%
  urlcolor=\ifiseries@hypercolor,%
}
\RequirePackage[strict]{changepage}
\ififiseries@tikz
  \RequirePackage{tikz}
  \usetikzlibrary{positioning}
  \usetikzlibrary{arrows}
  \usetikzlibrary{shapes}
  \usetikzlibrary{shadows}
  \usetikzlibrary{decorations.text}
  \usetikzlibrary{decorations.markings}
  \usetikzlibrary{decorations.pathmorphing}
  \usetikzlibrary{petri}
  \usetikzlibrary{shapes.symbols}
  \usetikzlibrary{shapes.arrows}
  \usetikzlibrary{decorations}
  \usetikzlibrary{decorations.pathreplacing}
  \usetikzlibrary{decorations.shapes}
  \usetikzlibrary{calc}
  \usetikzlibrary{chains}
  \usetikzlibrary{patterns}
  \usetikzlibrary{matrix}
  \usetikzlibrary{backgrounds}
  \usetikzlibrary{mindmap}
  \usetikzlibrary{topaths}
  \usetikzlibrary{automata}
\fi
\RequirePackage{pgfplots}
\pgfplotsset{compat=\ifiseries@pgfplotscompat}
\RequirePackage{microtype}
\RequirePackage{enumitem} %%% add 'inline' option once it is supported everywhere
\newlist{compactitemize}{itemize}{3}
\setlist[compactitemize]{label=\raisebox{.1em}{\smaller\textbullet}}
\newlist{compactenumerate}{enumerate}{2}
\setlist[compactenumerate]{label=\arabic*.}
\newlist{compactdescription}{description}{3}
\RequirePackage{placeins}
\RequirePackage[draft]{fixme}
\fxsetup{theme=color}

\ExplSyntaxOn
\str_case:onF{\ifiseries@acronymPackage}{
  {acronym} {
      \RequirePackage[\ifiseries@acronymOptions]{acronym}%
  }
  {acro} {
      \RequirePackage{acro}%
      % We need a custom list to make sure the list item indentation works properly with extra information
      \newlist{kcssacronyms}{description}{1}
      \setlist[kcssacronyms]{
          leftmargin = !,
          labelwidth=\ifiseries@acroLabelWidth
      }
      % Define custom list and extra styles
      \DeclareAcroListStyle{kcssacrolist}{list}{
          list = kcssacronyms
      }
      \DeclareAcroExtraStyle{newline}{inline}{
          brackets = false,
          punct = true,
          punct-symbol = \\
      }
      % Basic acro setup with sensible defaults
      \acsetup{
          extra-format = {\footnotesize},
          extra-style = newline,
          label-prefix = lbl:,
          list-caps = true,
          list-heading = chapter*,
          list-short-width = 10em,
          list-style = kcssacrolist,
          hyperref = false,
          page-style = none,
          short-format = {\smaller},
          sort = true,
      }
      % Our list name depends on the language
      \str_case:on{\ifiseries@language}{
          {english} {
              \acsetup{
                  list-name = List\ of\ Acronyms,
              }
          }
          {german} {
              \acsetup{
                  list-name = Akronymverzeichnis,
              }
          }
      }
  }
}{\PackageError{ifiseries}{Unsupported~acronyms~package:~\ifiseries@acronymPackage}\@ehc}
\ExplSyntaxOff

\RequirePackage{xspace}
\RequirePackage[\ifiseries@hyphenatOptions]{hyphenat}
\RequirePackage[shortcuts]{extdash}
\RequirePackage{eurosym}
\RequirePackage[full]{textcomp}
\RequirePackage{ellipsis}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Useful commands

%% Remove margins for screen viewing.
%% This command is used by the code below if 'compact' is set.
%% It is the same as the '\nomargin' command in 'localKit'.
\newcommand*{\nomargin}{
  \setlength{\oddsidemargin}{.02\textwidth-1in}
  \setlength{\evensidemargin}{.02\textwidth-1in}
  \setlength{\paperwidth}{1.04\textwidth}
  \setlength{\paperheight}{\headheight+\headsep+\textheight+\footskip}
  \setlength{\paperheight}{1.04\paperheight}
  \setlength{\topmargin}{.02\paperheight-1in}
}

%% Abbreviations
\newcommand*{\abbrdot}{\protect\@ifnextchar.{}{.\@\xspace}}
\newcommand*{\abbrcomma}{\protect\@ifnextchar,{}{,\xspace}}
\newcommand*{\eg}{e.\@\,g.\@\abbrcomma}
\newcommand*{\ie}{i.\@\,e.\@\abbrcomma}
\newcommand*{\cf}{cf\abbrdot}
\newcommand*{\Eg}{E.\@\,g.\@\abbrcomma}
\newcommand*{\Ie}{I.\@\,e.\@\abbrcomma}
\newcommand*{\Cf}{Cf\abbrdot}
\newcommand*{\etal}{et~al\abbrdot}
\newcommand*{\etc}{etc\abbrdot}
\newcommand*{\vs}{vs\abbrdot}
\newcommand*{\Wlg}{W.l.o.g\abbrdot}
\newcommand*{\wlg}{w.l.o.g\abbrdot}
\newcommand*{\OBdA}{O.B.d.A\abbrdot}
\newcommand*{\oBdA}{o.B.d.A\abbrdot}
\newcommand*{\wrt}{w.r.t.\@\xspace}
\newcommand*{\rv}{r.v.\@\xspace}
\newcommand*{\aka}{a.k.a.\@\xspace}
\newcommand*{\ellipsis}{…\xspace}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Paragraph skip instead of paragraph indentation.

%% This should go behind \ififiseries@layout, but on the other hand
%% it must happen before we load theorems. It should not be a problem
%% to have it here since it will only do something if option halfparskip
%% is set.

\ififiseries@halfparskip
    \setlength{\parskip}{.5\baselineskip plus .5\baselineskip}
    \setlength{\parindent}{0em}
    \setlength{\parfillskip}{\ifiseries@halfparskipfill\textwidth plus 1fil}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Theorems. If 'theorems' is empty, nothing happens here.

\ExplSyntaxOn
\str_case:onF{\ifiseries@theorems}{
{} {\relax}
{numbersfirst} {
  \ififiseries@dottednumbers% FIXME how can I pass through boolean options?
    \RequirePackage[within=\ifiseries@theoremswithin,likeequations,language=\ifiseries@language,dottednumbers=true,plainfont=\ifiseries@theoremsplainfont,remarkfont=\ifiseries@theoremsremarkfont]{localTheorem}%
  \else%
    \RequirePackage[within=\ifiseries@theoremswithin,likeequations,language=\ifiseries@language,dottednumbers=false,plainfont=\ifiseries@theoremsplainfont,remarkfont=\ifiseries@theoremsremarkfont]{localTheorem}%
  \fi%
  \let\@subsection\subsection%
  \renewcommand*\subsection{\@ifnextchar*{\@subsection}{\@subsection*}}%
  \let\@subsubsection\subsubsection%
  \renewcommand*\subsubsection{\@ifnextchar*{\@subsubsection}{\@subsubsection*}}%
}
{numberslast} {
  \ififiseries@dottednumbers%
    \RequirePackage[within=\ifiseries@theoremswithin,numbersfirst=false,language=\ifiseries@language,dottednumbers=true,plainfont=\ifiseries@theoremsplainfont,remarkfont=\ifiseries@theoremsremarkfont]{localTheorem}%
  \else%
    \RequirePackage[within=\ifiseries@theoremswithin,numbersfirst=false,language=\ifiseries@language,dottednumbers=false,plainfont=\ifiseries@theoremsplainfont,remarkfont=\ifiseries@theoremsremarkfont]{localTheorem}%
  \fi%
}
}{\PackageError{ifiseries}{Unknown~theorem~system:~\ifiseries@theorems}\@ehc}
\ExplSyntaxOff

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Display settings.
%%%% This used to be in the layout section below, but now I feel
%%%% that it is almost always a good idea (2014-01-07).

\allowdisplaybreaks
\AtBeginDocument{
  \setlength{\abovedisplayshortskip}{-.5\baselineskip plus .5\baselineskip}
  \setlength{\abovedisplayskip}{\medskipamount}
  \setlength{\belowdisplayshortskip}{\medskipamount}
  \setlength{\belowdisplayskip}{\medskipamount}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Enumeration environments.
%%%% This used to be in the layout section below, but now I feel
%%%% that it is almost always a good idea (2014-01-08).

\ififiseries@halfparskip
%
% For halfparskip, we set topsep to 0 everywhere.
% This seems to be necessary to prevent excessive whitespace.
%
\setitemize{leftmargin=*, label=$\triangleright$, topsep=0em}
\setenumerate{leftmargin=*, topsep=0em}
\setdescription{leftmargin=\parindent, style=sameline, font=\it, topsep=0em}
\setlist[compactitemize]{%
  label=\raisebox{.1em}{\smaller\textbullet},%
  leftmargin=*,%
  topsep=.0em plus .1em,%
  parsep=.2em plus .1em,%
  itemsep=.2em plus .1em,%
}
\setlist[compactitemize,2,3]{%
  topsep=.0em,%
  partopsep=.1em,%
  parsep=.1em,%
  itemsep=.1em,%
}
%
\setlist[compactenumerate]{%
  label=\arabic*.,%
  leftmargin=*,%
  topsep=.0em plus .1em,%
  parsep=.2em plus .1em,%
  itemsep=.2em plus .1em,%
}
% FIXME: third level does not work for compactenumerate
\setlist[compactenumerate,2]{%
  label=(\alph*),%
  topsep=.0em,%
  partopsep=.1em,%
  parsep=.1em,%
  itemsep=.1em,%
}
%
\setlist[compactdescription]{%
  style=sameline,%
  font=\it,%
  leftmargin=\parindent,%
  topsep=.0em plus .1em,%
  parsep=.2em plus .1em,%
  itemsep=.2em plus .1em,%
}
\setlist[compactdescription,2,3]{%
  topsep=.0em,%
  partopsep=.1em,%
  parsep=.1em,%
  itemsep=.1em,%
}
\else
%
% Settings for non-halfparskip (the normal settings).
%
\@ifclassloaded{beamer}{\setitemize{leftmargin=*,%
  label={\usebeamercolor[fg]{itemize item}%
  \scriptsize\raise1.25pt\hbox{\donotcoloroutermaths$\blacktriangleright$}}}%
  \setenumerate{leftmargin=*}%
  \setdescription{font={\normalfont\usebeamercolor[fg]{itemize item}}}}%
  {\setitemize{leftmargin=*, label=$\triangleright$}%
   \setenumerate{leftmargin=*}%
   \setdescription{leftmargin=\parindent, style=sameline, font=\it}}
\setlist[compactitemize]{%
  label=\raisebox{.1em}{\smaller\textbullet},%
  leftmargin=*,%
  topsep=.4em plus .1em,%
  parsep=.2em plus .1em,%
  itemsep=.2em plus .1em,%
}
\setlist[compactitemize,2,3]{%
  topsep=.1em,%
  partopsep=.1em,%
  parsep=.1em,%
  itemsep=.1em,%
}
%
\setlist[compactenumerate]{%
  label=\arabic*.,%
  leftmargin=*,%
  topsep=.4em plus .1em,%
  parsep=.2em plus .1em,%
  itemsep=.2em plus .1em,%
}
\setlist[compactenumerate,2,3]{%
  topsep=.1em,%
  partopsep=.1em,%
  parsep=.1em,%
  itemsep=.1em,%
}
%
\setlist[compactdescription]{%
  style=sameline,%
  font=\it,%
  leftmargin=\parindent,%
  topsep=.4em plus .1em,%
  parsep=.2em plus .1em,%
  itemsep=.2em plus .1em,%
}
\setlist[compactdescription,2,3]{%
  topsep=.1em,%
  partopsep=.1em,%
  parsep=.1em,%
  itemsep=.1em,%
}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Hyperref's \autoref feature.
%%%% This used to be in the layout section below, but now I feel
%%%% that it is almost always a good idea (2014-01-09).

\@ifclassloaded{beamer}{}{%
\providecommand*{\subfigureautorefname}{\figureautorefname}
% \extrasenglish seem to be invoked twice, so need \renew.. there, hence all \...refname must be defined
\ifthenelse{\isundefined{\algocfautorefname}}{\newcommand*{\algocfautorefname}{Algorithm}}{}
\ifthenelse{\isundefined{\algorithmautorefname}}{\newcommand*{\algorithmautorefname}{Algorithm}}{}
\addto\extrasenglish{
  \renewcommand*{\chapterautorefname}{Chapter}
  \renewcommand*{\sectionautorefname}{Section}
  \renewcommand*{\subsectionautorefname}{Section}
  \renewcommand*{\subsubsectionautorefname}{Section}
  \renewcommand*{\algocfautorefname}{Algorithm}
  \renewcommand*{\algorithmautorefname}{Algorithm}}
\addto\extrasngerman{
  \renewcommand*{\chapterautorefname}{Kapitel}
  \renewcommand*{\sectionautorefname}{Abschnitt}
  \renewcommand*{\subsectionautorefname}{Abschnitt}
  \renewcommand*{\subsubsectionautorefname}{Abschnitt}
  \renewcommand*{\algocfautorefname}{Algorithmus}
  \renewcommand*{\algorithmautorefname}{Algorithmus}}
} %%% end ifclassloaded not beamer

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Configure listings package.
%%%% This used to be in the layout section below, but now I feel
%%%% that it is almost always a good idea (2014-01-11).

\lstset{basicstyle=\tt}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Packages and settings with influence on the main layout

\ififiseries@layout

\newcommand*{\ifiseries@titlefontfamily}{}
\newcommand*{\ifiseries@sectionfontweight}{\bfseries}
\newcommand*{\ifiseries@chapterfontweight}{\bfseries}

%% Font and linespread.
\ExplSyntaxOn
\str_case:onF{\ifiseries@font}{
{} {\relax}
{Arial} {
  \RequirePackage[sfmath]{kpfonts}
  \RequirePackage{uarial}
  \renewcommand*\familydefault{\sfdefault}
  \linespread{1.05}
}
{BaskervaldX} {
  \RequirePackage[lf]{Baskervaldx}%
  \RequirePackage[bigdelims,vvarbb]{newtxmath}%
  \RequirePackage[cal=boondoxo]{mathalfa}%
  \renewcommand*\oldstylenums[1]{\textosf{#1}}%
}
{Bera} {
  \RequirePackage[scaled]{beraserif}%
  \RequirePackage[scaled=.86]{berasans}%
  \RequirePackage[scaled=.86]{beramono}%
  \linespread{1.05}%
}
{BeraSans} {
  \RequirePackage[sfmath]{kpfonts} % only for the math
  \RequirePackage[scaled]{beraserif}
  \RequirePackage[scaled=.86]{berasans}
  \RequirePackage[scaled=.86]{beramono}
  \linespread{1.05}
  \renewcommand*\familydefault{\sfdefault}
}
{Charter} { %% sometimes problem: "Too many math alphabets used in version normal."
  \RequirePackage[bitstream-charter]{mathdesign}%
  \RequirePackage[scaled]{berasans}%
  \RequirePackage[scaled]{beramono}%
  \RequirePackage{eucal}%
  \linespread{1.05}%
}
{CharterText} { %% FIXME: how to prevent charter replacing mathcal?
  %\RequirePackage{lmodern}% looks also good, but too small
  \RequirePackage{eulervm}%
  \RequirePackage{charter}%
  \RequirePackage[scaled]{berasans}%
  \RequirePackage[scaled]{beramono}%
  \RequirePackage{eucal}%
  \linespread{1.05}%
}
{ConcreteEuler} {
  \RequirePackage{lmodern}%
  \RequirePackage[boldsans]{concmath}%
  \RequirePackage{eulervm}%
  \RequirePackage[scaled=.84]{beramono}%
  \linespread{1.05}%
}
{DejaVu} {
  \RequirePackage[scaled]{DejaVuSerif}
  \RequirePackage{eulervm}
  \RequirePackage[scaled=.95]{beramono}
  \linespread{1.10}
}
{DejaVuCondensed} {
  \RequirePackage[scaled]{DejaVuSerifCondensed}
  \RequirePackage{eulervm}
  \RequirePackage[scaled=.95]{beramono}
  \linespread{1.10}
}
{Droid} {
  % NOTE: might look better without bold
  % \RequirePackage{mathpazo}% only for the math, use scale=.96 with this
  \RequirePackage{concmath}%
  \RequirePackage[scale=.90,default]{droidserif}
  \RequirePackage[scale=.90,defaultsans]{droidsans}
  \RequirePackage[scale=.90,defaultmono]{droidmono}
  \linespread{1.10}
}
{GaramondMathdesign} { %% sometimes problem: "Too many math alphabets used in version normal."
  \RequirePackage[urw-garamond]{mathdesign}%
  \RequirePackage{eucal}%
  \RequirePackage[scaled=.82]{berasans}%
  \RequirePackage[scaled=.82]{beramono}%
  \linespread{1.05}%
}
{GaramondExpertMathdesign} {
  \RequirePackage[urw-garamond]{mathdesign}
  \RequirePackage{garamondx}
  \RequirePackage[scaled=.82]{berasans}
  \RequirePackage[scaled=.82]{beramono}
  \linespread{1.05}
}
{GaramondExpertNewTX} {
  \RequirePackage{garamondx}
  \RequirePackage[garamondx,cmbraces]{newtxmath}
  \RequirePackage[scaled=.85]{berasans}
  \RequirePackage[scaled=.85]{beramono}
  \linespread{1.05}
}
{Helvetica} {
  \RequirePackage[sfmath]{kpfonts}
  \RequirePackage{helvet}
  \renewcommand{\familydefault}{\sfdefault}
  \fontfamily{phv}\selectfont
}
{Heros} {
  \RequirePackage[sfmath]{kpfonts}
  \RequirePackage{tgheros}
  \renewcommand*\familydefault{\sfdefault}
  \linespread{1.08}
}
{Heuristica} {
  \RequirePackage{heuristica}
  \RequirePackage[heuristica,vvarbb,bigdelims]{newtxmath}
  \renewcommand*\oldstylenums[1]{\textosf{#1}}
  \linespread{1.10}
}
{Kerkis} { %% some problems in math mode, e.g., tildas extend into symbols
  \usepackage{kmath,kerkis}%
  \let\openbox\@undefined%
  \RequirePackage[scaled=.81]{berasans}%
  \RequirePackage[scaled=.81]{beramono}%
  \renewcommand*{\bfdefault}{sb}%
  \linespread{1.10}%
}
{KP} {
  \RequirePackage{kpfonts}%
  \linespread{1.05}%
}
{KPSans} {
  \RequirePackage[sfmath]{kpfonts}
  \renewcommand*\familydefault{\sfdefault}
  \linespread{1.05}
}
{LatinModern} {
  \RequirePackage{lmodern}%
  \RequirePackage[scaled=.80]{beramono}%
  \let\@bfseries\bfseries%
  \renewcommand*{\bfseries}{\sffamily\@bfseries\fontseries{sbc}\selectfont}%
  \linespread{1.05}%
}
{LatinModernBold} {
  \RequirePackage{lmodern}%
  \RequirePackage[scaled=.80]{beramono}%
  \linespread{1.05}%
}
{LinuxLibertine} {
  \RequirePackage{libertine}
  \RequirePackage{libertinust1math}
  \linespread{1.05}
}
{NewCenturySchoolbook} {
  \RequirePackage{fouriernc}%
  \RequirePackage[scaled=.85]{beramono}%
  \linespread{1.10}%
}
{NewPX} {
  \RequirePackage{newpxtext,newpxmath}%
  \RequirePackage[scaled=.86]{berasans}%
  \RequirePackage[scaled=.86]{beramono}%
  \linespread{1.05}%
}
{NewTX} {
  \RequirePackage{newtxtext,newtxmath}%
  \RequirePackage[scaled=.84]{berasans}%
  \RequirePackage[scaled=.84]{beramono}%
  \linespread{1.05}%
}
{Palatino} {
  \RequirePackage[sc]{mathpazo}%
  \@ifclassloaded{beamer}{%
    \RequirePackage[scaled=.90]{helvet}%
    \RequirePackage[scaled=.80]{beramono}%
  }{%
    \RequirePackage[scaled=.80]{berasans}%
    \RequirePackage[scaled=.80]{beramono}%
  }%
  \linespread{1.05}%
  \ExplSyntaxOn
  \str_case:onF {\ifiseries@PalatinoSC} {
    {ppl} {\AtBeginDocument{\DeclareFontShape{T1}{pplx}{bx}{sc}{<->ssub*ppl/bx/sc}{}}}
    {jkp} {\AtBeginDocument{\DeclareFontShape{T1}{pplx}{bx}{sc}{<->ssub*jkp/bx/sc}{}}}
    {none} {}
  }{\PackageError{ifiseries}{Unsupported~Palatino~Smallcaps:~\ifiseries@PalatinoSC}\@ehc}
  \ExplSyntaxOff
}
{Schola} {
  \RequirePackage{fouriernc}% only for the math
  \RequirePackage{tgschola}%
  \DeclareMathAlphabet{\mathcal}{OMS}{cmsy}{m}{n}%
  \RequirePackage[scaled=.88]{beramono}%
  \linespread{1.05}%
}
{Stix} { %%% causes lots of conflicts with macros from newKit
  \RequirePackage{stix}%
  \RequirePackage[scaled=.86]{berasans}%
  \RequirePackage[scaled=.86]{beramono}%
  \linespread{1.05}%
}
{Times} {
  \RequirePackage{mathptmx}%
  \DeclareMathAlphabet{\mathcal}{OMS}{cmsy}{m}{n}%
  \RequirePackage[scaled=.87]{helvet}%
  \RequirePackage[scaled=.82]{beramono}%
  \linespread{1.05}%
}
{Termes} {
  \RequirePackage{tgtermes}%
  \RequirePackage[scaled=.86]{berasans}%
  \RequirePackage[scaled=.86]{beramono}%
  \linespread{1.05}%
}
{TX} {
  \RequirePackage{txfonts}%
  \RequirePackage[scaled=.86]{berasans}%
  \RequirePackage[scaled=.86]{beramono}%
  \linespread{1.05}%
}
{Utopia} {
  \RequirePackage[widespace]{fourier}%
  \RequirePackage{eucal}%
  \RequirePackage[scaled=.82]{berasans}%
  \RequirePackage[scaled=.82]{beramono}%
  \linespread{1.05}%
}
{UtopiaMathdesign} { %% sometimes problem: "Too many math alphabets used in version normal."
  \RequirePackage[adobe-utopia]{mathdesign}%
  \RequirePackage{eucal}%
  \RequirePackage[scaled=.82]{berasans}%
  \RequirePackage[scaled=.82]{beramono}%
  \linespread{1.05}%
}
}{\PackageError{ifiseries}{Unknown~font:~\ifiseries@font}\@ehc}
\ExplSyntaxOff

%% \prg_case_str cannot occur inside an argument.
%% So we have to prepare several commands here to be called later
%% inside the \@ifclassloaded.
\ExplSyntaxOn
%
\newcommand{\ifiseries@temp@paper}{
\str_case:onF{\ifiseries@paper} {
  {} {\relax}
  {ustrade} {\geometry{paperwidth=15.24cm, paperheight=22.86cm}}
  {15522} {\geometry{paperwidth=15.50cm, paperheight=22.00cm}}
  {royal} {\geometry{paperwidth=15.57cm, paperheight=23.39cm}}
  {crownquarto} {\geometry{paperwidth=18.91cm, paperheight=24.589cm}}
  {kindlefirehd7} {\geometry{paperwidth=3.703704in, paperheight=5.925926in}}
  {5x8} {\geometry{paperwidth=12.7cm, paperheight=20.32cm}}
}{\geometry{paper=\ifiseries@paper}}}
%
\newcommand{\ifiseries@temp@compact}{
\str_case:onF{\ifiseries@compact}{
  {} {\relax}
  {moderate} {
    \setlength{\headsep}{.5\baselineskip}%
    \setlength{\footskip}{\baselineskip}%
    \nomargin%
  }
  {strong} {
    %% This does the same as the '\ebook' command in 'localKit'.
    \fancyhf{}%
    \fancyfoot[R]{\thepage}%
    \fancypagestyle{plain}{\fancyhf{}\fancyfoot[R]{\thepage}}%
    \setlength{\headsep}{0pt}%
    \setlength{\headheight}{0pt}%
    %\setlength{\topskip}{0pt}% affects height of textblock in ways difficult to determine!
    \setlength{\footskip}{1.5\baselineskip}%
    \setlength{\oddsidemargin}{.02\textwidth-1in}%
    \setlength{\evensidemargin}{.02\textwidth-1in}%
    \setlength{\paperwidth}{1.04\textwidth}%
    \setlength{\paperheight}{\textheight+\footskip}%
    \setlength{\topmargin}{.005\paperheight-1in}% CHANGE
    \setlength{\paperheight}{1.02\paperheight}%
  }
  {expand} {
    %% This gives a compact layout, but by expanding the textblock into the margins.
    %% Page width and height is maintained.
    \geometry{%
      headheight=0em,%
      headsep=0em,%
      left=.02\paperwidth,%
      right=.02\paperwidth,%
      top=.01\paperheight,%
      footskip=\baselineskip,%
      bottom=\baselineskip}%
    \setlength{\headwidth}{\textwidth}%
    \fancyhf{}\fancyfoot[R]{\thepage}%
    \fancypagestyle{plain}{\fancyhf{}\fancyfoot[R]{\thepage}}%
  }
}{\PackageError{ifiseries}{Unknown~compact~system:~\ifiseries@compact}\@ehc}}
\ExplSyntaxOff
%% End of preparations.

\@ifclassloaded{beamer}{}{%
%% Page layout.
\ififiseries@pagelayout
\RequirePackage{geometry}
\ifiseries@temp@paper
\ifdefempty{\ifiseries@paperheight}{}{\ifdefempty{\ifiseries@paperwidth}{}%
  {\geometry{paperwidth=\ifiseries@paperwidth,paperheight=\ifiseries@paperheight}}}
%
\ifthenelse
  {\equal{\@ptsize}{1}}
  {\setlength{\headheight}{13.59999pt}}
  {\ifthenelse
    {\equal{\@ptsize}{2}}
    {\setlength{\headheight}{14.49998pt}}
    {}}
%
\ifdefempty{\ifiseries@margincontrol}{%
\ififiseries@onemargin
\geometry{%
heightrounded, %
headsep=\ifiseries@headsepmult\baselineskip, %
footskip=\ifiseries@footskipmult\baselineskip, %
inner=0.1in, %
outer=(3\paperwidth/\ifiseries@marginfrac)-0.1in, %
marginparwidth=(3\paperwidth/\ifiseries@marginfrac)-0.3in, %
top=\paperheight/\ifiseries@marginfrac, vmarginratio=1:2}
\ififiseries@includehead\geometry{includehead}\fi
\else
\ififiseries@hcenter
\geometry{%
heightrounded, %
headsep=\ifiseries@headsepmult\baselineskip, %
footskip=\ifiseries@footskipmult\baselineskip, %
inner=(3\paperwidth/(2*\ifiseries@marginfrac))+\ifiseries@bindingcorrection, %
outer=(3\paperwidth/(2*\ifiseries@marginfrac))-\ifiseries@bindingcorrection, %
top=\paperheight/\ifiseries@marginfrac, vmarginratio=1:2}
\ififiseries@includehead\geometry{includehead}\fi
\else
\geometry{%
heightrounded, %
headsep=\ifiseries@headsepmult\baselineskip, %
footskip=\ifiseries@footskipmult\baselineskip, %
inner=(\paperwidth/\ifiseries@marginfrac)+\ifiseries@bindingcorrection, %
outer=(2\paperwidth/\ifiseries@marginfrac)-\ifiseries@bindingcorrection, %
top=\paperheight/\ifiseries@marginfrac, vmarginratio=1:2}
\ififiseries@includehead\geometry{includehead}\fi
\fi
\fi
}{\expandafter\geometry\expandafter{\ifiseries@margincontrol}}
\fi % pagelayout

%% Folios and running titles (and others, see below).
\ififiseries@leftmarkright\let\rightmark\leftmark\fi
\RequirePackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\@ifclassloaded{book}{%
\let\@frontmatter\frontmatter
\renewcommand*{\frontmatter}{\@frontmatter\renewcommand*{\chaptermark}[1]{\markboth{##1}{##1}}}
\let\@mainmatter\mainmatter
\renewcommand*{\mainmatter}{\@mainmatter\renewcommand*{\chaptermark}[1]{\markboth{\thechapter. \ ##1}{}}}
\let\@backmatter\backmatter
\renewcommand*{\backmatter}{\@backmatter\bookmarksetup{startatroot}}
\let\@appendix\appendix
\renewcommand*{\appendix}{\bookmarksetup{startatroot}\@appendix}
\if@twoside
\ififiseries@runningtitle\fancyhead[LE]{\nouppercase{\leftmark}}\fi
\else
\ififiseries@runningtitle\fancyhead[C]{\nouppercase{\leftmark}}\fi
\fi
}{ %%% else ifclassloaded book
\if@twoside
\ififiseries@runningtitle\fancyhead[LE]{\nouppercase{\rightmark}}\fi
\else
\ififiseries@runningtitle\fancyhead[C]{\nouppercase{\rightmark}}\fi
\fi
} %%% end ifclassloaded book
\renewcommand*{\headrulewidth}{0pt}
\if@twoside
\ififiseries@runningtitle\fancyhead[RO]{\nouppercase{\rightmark}}\fi
\fancyfoot[RO]{\thepage}
\fancyfoot[LE]{\thepage}
\fancypagestyle{plain}{\fancyhf{}\fancyfoot[LE]{\thepage}\fancyfoot[RO]{\thepage}}
\else
\ififiseries@runningtitle\fancyhead[C]{\nouppercase{\rightmark}}\fi
\fancyfoot[C]{\thepage}
\fancypagestyle{plain}{\fancyhf{}\fancyfoot[C]{\thepage}}
\fi

%% Compact system: reduce margins.
\ifiseries@temp@compact

%% Empty clearpages (i.e., pages left blank before a chapter start).
\renewcommand*{\cleardoublepage}{%
  \clearpage
  \if@twoside
    \ifodd
      \c@page
    \else
      \thispagestyle{empty}
      \hbox{}
      \newpage
      \if@twocolumn
        \hbox{}
        \newpage
      \fi
    \fi
  \fi
}

%% Section headings.
\@ifclassloaded{dinbrief}{\newcommand{\section}[1]{}}{%%% FIXME what's a good definition for \section in dinbrief?
\RequirePackage{sectsty}
\sectionfont{\normalfont\Large\ifiseries@sectionfontweight\ifiseries@titlefontfamily}
\subsectionfont{\normalfont\large\ifiseries@sectionfontweight\ifiseries@titlefontfamily}
\subsubsectionfont{\normalfont\normalsize\ifiseries@sectionfontweight\ifiseries@titlefontfamily}
\ififiseries@dottednumbers
  \def\@seccntformat#1{\csname the#1\endcsname.\quad}
  \def\@subseccntformat#1{\csname the#1\endcsname.\quad}
  \def\@subsubseccntformat#1{\csname the#1\endcsname.\quad}
\fi

%% Part title page (package 'sectsty' must be loaded first).
\newenvironment{centerpage}%
  {\begin{adjustwidth*}%
    {(\paperwidth-\textwidth)/2-1in-\oddsidemargin+\ifiseries@bindingcorrection}%
    {(\paperwidth-\textwidth)/2-1in-\evensidemargin-\ifiseries@bindingcorrection}%
  \centering}%
  {\end{adjustwidth*}}
\newcommand*{\typesetpart}[1]{{%
  \begin{centerpage}
  \null
  \vspace{.20\textheight}
  \interlinepenalty \@M
  \normalfont
  \ifnum \c@secnumdepth >-2\relax
    \LARGE\bfseries\ifiseries@titlefontfamily \partname\nobreakspace\thepart
    \par\normalsize\normalfont
    \vskip 20\p@
  \fi
  \Huge \bfseries \ifiseries@titlefontfamily #1\par
  \end{centerpage}
}}
\renewcommand*{\part}{%
  \if@openright
    \FloatBarrier
    \newpage\thispagestyle{empty}\hbox{}
    \cleardoublepage
  \else
    \clearpage
  \fi
  \thispagestyle{empty}%
  \if@twocolumn
    \onecolumn
    \@tempswatrue
  \else
    \@tempswafalse
  \fi
  \secdef\@part\@spart%
}
\renewcommand*{\@part}[2][]{%
  \ifnum \c@secnumdepth >-2\relax
    \refstepcounter{part}%
    \addcontentsline{toc}{part}{\thepart\hspace{1em}#1}%
  \else
    \addcontentsline{toc}{part}{#1}%
  \fi
  \markboth{}{}%
  \typesetpart{#2}%
  \@endpart%
}

%% Chapter titles
%% cf. texlive/2011/texmf-dist/tex/latex/base/book.cls
\@ifclassloaded{book}{%
\renewcommand*{\@makechapterhead}[1]{%
  %\vspace*{20\p@}%
  {\parindent \z@ \flushright \normalfont
    \ifnum \c@secnumdepth >\m@ne
      \if@mainmatter
        \large\ifiseries@chapterfontweight\ifiseries@titlefontfamily \@chapapp\space \thechapter
        \par\normalsize\normalfont\nobreak
        \vskip 20\p@
      \fi
    \fi
    \interlinepenalty\@M
    \huge \ifiseries@chapterfontweight \ifiseries@titlefontfamily #1\par\nobreak
    \vskip 50\p@
  }}
\renewcommand*{\@makeschapterhead}[1]{%
  %\vspace*{50\p@}%
  {\parindent \z@ \flushright
    \normalfont
    \interlinepenalty\@M
    {\huge\bfseries  #1\par\nobreak}
    \vskip 50\p@
  }}
}{} %%% end ifclassloaded book
} %%% end ifclassloaded not beamer
} % end ifclassloaded not dinbrief

%% Bibliography.
\@ifclassloaded{book}{%
\newcommand*{\preparebibliography}{%
\renewcommand*{\refname}{\ifiseries@refname}%
\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{\refname}
}%
\newcommand*{\tocbibliography}{%
\preparebibliography%
\ififiseries@biblatex\printbibliography\else\bibliography{\ifiseries@bibresource}\fi}}{%
\newcommand*{\preparebibliography}{%
\renewcommand*{\refname}{\ifiseries@refname}%
\phantomsection
\addcontentsline{toc}{section}{\refname}
}%
\newcommand*{\tocbibliography}{%
\preparebibliography%
\ififiseries@biblatex\printbibliography\else\bibliography{\ifiseries@bibresource}\fi}}

%% For multiple authors.
\newcommand*{\andauthor}{\\[.5\baselineskip]}

%% Command to create generic cover pages.
\ifthenelse{\equal{\ifiseries@compact}{}}{\newcommand*{\ifiseries@titlepagetopskip}{}}%
  {\newcommand*{\ifiseries@titlepagetopskip}{\vspace*{5ex}}}
\newcommand{\gentitlepage}[4]{%
\newpage
\thispagestyle{empty}
\begin{centerpage}
\ifiseries@titlepagetopskip%
\Huge \ifthenelse{\expandafter\isempty\expandafter{#1}}{\mbox{ }}{#1}\\
\normalsize\vspace{5ex}
\Large \ifthenelse{\expandafter\isempty\expandafter{#2}}{\mbox{ }}{#2}\\
\normalsize\vspace{5ex}
\Large \ifthenelse{\expandafter\isempty\expandafter{#3}}{\mbox{ }}{#3}\\
\normalsize\vfill
#4
\end{centerpage}}
\newcommand{\titlepagetitle}{}
\newcommand{\titlepagesubtitle}{}
\newcommand{\titlepageauthor}{}
\newcommand{\titlepagetext}{}
\newcommand{\makegentitlepage}{\gentitlepage{\titlepagetitle}{\titlepagesubtitle}{\titlepageauthor}{\titlepagetext}}

%% Command to create the cover page for dissertations.
\newcommand{\disstitlepage}[5]{%
\gentitlepage{#1}{#2}{#3}{%
Dissertation\\
zur Erlangung des akademischen Grades\\
%
\expandafter\ifstrequal\expandafter{#4}{nat}{%
  Doktor der Naturwissenschaften\\%
  (Dr.~rer.~nat.)\\%
  }{\expandafter\ifstrequal\expandafter{#4}{ing}{%
  Doktor der Ingenieurwissenschaften\\%
  (Dr.-Ing.)\\%
  }{}}%
%
der Technischen Fakult\"at\\
der Christian-Albrechts-Universit\"at zu Kiel\\
eingereicht im Jahr #5}}
\newcommand{\disstitlepagedegree}{nat}
\newcommand{\disstitlepageyear}{\textbf{?? Year ??}}
\newcommand{\makedisstitlepage}{\disstitlepage%
{\titlepagetitle}%
{\titlepagesubtitle}%
{\titlepageauthor}%
{\disstitlepagedegree}%
{\disstitlepageyear}}

%% Command to create the cover page for student's thesis.
\newcommand{\studtitlepage}[7]{%
\gentitlepage{#1}{#2}{#3}{%
#4\\
#5\\
\vspace{1ex}
\ifthenelse{\isempty{#6}}{}{#6\\}%
\iflanguage{english}{Department of Computer Science\\
Kiel University}{%
\iflanguage{ngerman}{Institut f\"ur Informatik\\
Christian-Albrechts-Universit\"at zu Kiel}{}%
}\\
\vspace{1ex}
\iflanguage{english}{Advised by }{%
\iflanguage{ngerman}{Betreut durch }{}%
}\\
#7
}}
\newcommand{\studtitlepagetype}{Bachelor-Arbeit}
\newcommand{\studtitlepageyear}{\textbf{?? Year ??}}
\newcommand{\studtitlepagegroup}{\textbf{?? Research Group ??}}
\newcommand{\studtitlepagesupervisor}{\textbf{?? Supervisor ??}}
\newcommand{\makestudtitlepage}{\studtitlepage%
{\titlepagetitle}%
{\titlepagesubtitle}%
{\titlepageauthor}%
{\studtitlepagetype}%
{\studtitlepageyear}%
{\studtitlepagegroup}%
{\studtitlepagesupervisor}}

%% Command to create the reviewer page for dissertations.
\newcommand{\dissreviewerpage}[4]{%
\newpage
\thispagestyle{plain}
\vspace*{.5\textheight}
\noindent
\begin{tabular}{@{}p{.20\textwidth}@{\hspace{.05\textwidth}}p{.75\textwidth}@{}}
  1.~Gutachter: & \ifthenelse{\equal{#1}{_}}{\rule{12em}{.3pt}}{#1} \\[1em]
  2.~Gutachter: & \ifthenelse{\equal{#2}{_}}{\rule{12em}{.3pt}}{#2}
  \ifthenelse{\equal{#3}{}}{}{\\[1em] 3.~Gutachter: & \ifthenelse{\equal{#3}{_}}{\rule{12em}{.3pt}}{#3}}
\end{tabular}
\par
\vspace*{2em}
\noindent
Datum der m\"undlichen Pr\"ufung:~\ifthenelse{\equal{#4}{_}}{\rule{12em}{.3pt}}{#4}}
\newcommand{\dissreviewerpagei}{_}
\newcommand{\dissreviewerpageii}{_}
\newcommand{\dissreviewerpageiii}{_}
\newcommand{\dissreviewerpagedate}{}
\newcommand{\makedissreviewerpage}{\dissreviewerpage%
{\dissreviewerpagei}%
{\dissreviewerpageii}%
{\dissreviewerpageiii}%
{\dissreviewerpagedate}}

%% Selbstständigkeitserklärung (formerly Eidesstattliche Erklärung)
\newcommand*{\eidesstatt}{%
\newpage
\thispagestyle{plain}
\hskip 0mm
\vfill
\begin{otherlanguage}{ngerman}
\noindent
\textbf{Selbstst{\"a}ndigkeitserkl{\"a}rung}\par
\bigskip\noindent Hiermit erkl{\"a}re ich,
dass ich die vorliegende Arbeit selbst\-st{\"a}n\-dig verfasst und keine
anderen als die angegebenen Quellen und Hilfsmittel verwendet habe.\par
\bigskip\noindent Kiel,
\vskip 10mm
\hfill\rule{18em}{.3pt}%
\end{otherlanguage}}

%% Command to create a page with meta data.
\newcommand{\metapage}[9]{%
\newpage%
\thispagestyle{plain}%
{\footnotesize%
\mbox{}\vfill%
\begin{itemize}[label=]%
  \item Kiel Computer Science Series (KCSS) #1%
  \ifthenelse{\expandafter\isempty\expandafter{#2}}{}{\\(revised edition of #2)}%
  \item
  URN:NBN #3\\
  ISSN 2193-6781 (print version)\\
  ISSN 2194-6639 (electronic version)
  \item Electronic version, updates, errata available via
       \url{https://www.informatik.uni-kiel.de/kcss}
  \ifthenelse{\expandafter\isempty\expandafter{#4}}{}{\item The author can be contacted via #4}%
  \item Published by the Department of Computer Science, Kiel University%
  \item #5%
  \item Please cite as:%
       \begin{itemize}%
         \item #6%
       \end{itemize}%
  \item \lstinputlisting[%
    nolol=true,frame=none,numbers=none,language={},style={},keywordsprefix={},basicstyle=\tt,%
    aboveskip=\medskipamount,belowskip=\medskipamount,lineskip=0pt,boxpos=c,print=true,%
    showlines=false,gobble=0,tabsize=8,showtabs=false,showspaces=false,%
    linewidth=\linewidth,xleftmargin=0pt,xrightmargin=0pt,resetmargins=false,breaklines=false,%
    columns={[c]fixed},flexiblecolumns=false,keepspaces=false,basewidth={0.6em,0.45em},fontadjust=false,%
    mathescape=false,escapechar={},escapeinside={},%
    ]{#7}%
  \item \textcopyright\ #8%
  \ifthenelse{\expandafter\isempty\expandafter{#8}}{}{\item #9}%
\end{itemize}}}
\newcommand{\metapageversion}{\textbf{?? dated ??}}
\newcommand{\metapagereplacedversion}{}
\newcommand{\metapageurnnbn}{\textbf{?? URN:NBN ??}}
\newcommand{\metapagecontact}{}
\newcommand{\metapagegroup}{\textbf{?? Research Group ??}}
\newcommand{\metapagecite}{\textbf{?? Citation ??}}
\newcommand{\metapagebibfile}{metapage.bib}
\newcommand{\metapagecopyright}{\textbf{?? Copyright ??}}
\newcommand{\metapagetext}{}
\newcommand{\makemetapage}{\metapage%
{\metapageversion}%
{\metapagereplacedversion}%
{\metapageurnnbn}%
{\metapagecontact}%
{\metapagegroup}%
{\metapagecite}%
{\metapagebibfile}%
{\metapagecopyright}%
{\metapagetext}}

%% Figures and captions.
\captionsetup{font=small,labelfont=bf,labelsep=period}
\ifdefstring{\ifiseries@figure}{floatrow}{%
  \captionsetup[subfigure]{labelformat=parens,labelsep=space}%
  \floatsetup[table]{style=plaintop}%
  \floatsetup[figure]{capbesideposition={center,inside},facing=yes}}{}
% Alter some defaults for better treatment of figures.
% Taken from http://mintaka.sdsu.edu/GF/bibliog/latex/floats.html
% See also p.105 of "TeX Unbound" for suggested values.
% General parameters, for ALL pages:
\renewcommand*{\topfraction}{0.9} % max fraction of floats at top
\renewcommand*{\bottomfraction}{0.8} % max fraction of floats at bottom
% Parameters for TEXT pages (not float pages):
\setcounter{topnumber}{2}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4} % 2 may work better
\setcounter{dbltopnumber}{2} % for 2-column pages
\renewcommand*{\dbltopfraction}{0.9} % fit big float above 2-col. text
\renewcommand*{\textfraction}{0.07} % allow minimal text w. figs
% Parameters for FLOAT pages (not text pages):
\renewcommand*{\floatpagefraction}{0.7} % require fuller float pages
% N.B.: floatpagefraction MUST be less than topfraction
\renewcommand*{\dblfloatpagefraction}{0.7} % require fuller float pages

%% Configure the url package, and adjust \href command.
\ifthenelse{\isundefined{\DeclareUrlCommand}}{\renewcommand*{\path}[1]{\url{#1}}}{\DeclareUrlCommand\path{}} %%% workaround
\renewcommand*{\UrlFont}{\smaller\tt}
\let\@href\href
\renewcommand*{\href}[3][]{\@href[#1]{#2}{\UrlFont #3}}
\newcommand*{\mailtohref}[1]{\href{mailto:#1}{#1}}

%% Optionally enable french spacing
\ififiseries@frenchspacing
\frenchspacing
\let\@selectlanguage\selectlanguage
%\RenewDocumentCommand\selectlanguage{m}{\selectlelanguage{#1}\frenchspacing}
\renewcommand{\selectlanguage}[1]{\@selectlanguage{#1}\frenchspacing}
\fi

\fi % ifiseries@layout