<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | This module contains a compiler pass that brings the bindings of all</span><span>
</span><a name="line-2"></a><span class="hs-comment">--   @let@-expressions in a module into reverse topological order.</span><span>
</span><a name="line-3"></a><span class="hs-comment">--</span><span>
</span><a name="line-4"></a><span class="hs-comment">--   = Examples</span><span>
</span><a name="line-5"></a><span class="hs-comment">--</span><span>
</span><a name="line-6"></a><span class="hs-comment">--   == Example 1</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">--   The bindings of the following @let@-expression are not topologically</span><span>
</span><a name="line-9"></a><span class="hs-comment">--   sorted because the right-hand side of @x@ depends on @y@ but @y@ is</span><span>
</span><a name="line-10"></a><span class="hs-comment">--   defined after @x@.</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">--   &gt; let { x = y; y = 42 } in x</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">--   This pass transforms the @let@-expression above into the following form.</span><span>
</span><a name="line-15"></a><span class="hs-comment">--</span><span>
</span><a name="line-16"></a><span class="hs-comment">--   &gt; let { y = 42; x = y } in x</span><span>
</span><a name="line-17"></a><span class="hs-comment">--</span><span>
</span><a name="line-18"></a><span class="hs-comment">--   == Example 2</span><span>
</span><a name="line-19"></a><span class="hs-comment">--</span><span>
</span><a name="line-20"></a><span class="hs-comment">--   If a @let@-expression contains (mutually) recursive bindings, a fatal</span><span>
</span><a name="line-21"></a><span class="hs-comment">--   error is reported.</span><span>
</span><a name="line-22"></a><span class="hs-comment">--</span><span>
</span><a name="line-23"></a><span class="hs-comment">--   &gt; let { x = y; y = x } in x</span><span>
</span><a name="line-24"></a><span class="hs-comment">--</span><span>
</span><a name="line-25"></a><span class="hs-comment">--   It is not clear at the moment how mutually recursive local variables</span><span>
</span><a name="line-26"></a><span class="hs-comment">--   can be represented when the sharing effect is used.</span><span>
</span><a name="line-27"></a><span class="hs-comment">--</span><span>
</span><a name="line-28"></a><span class="hs-comment">--   = Specification</span><span>
</span><a name="line-29"></a><span class="hs-comment">--</span><span>
</span><a name="line-30"></a><span class="hs-comment">--   == Preconditions</span><span>
</span><a name="line-31"></a><span class="hs-comment">--</span><span>
</span><a name="line-32"></a><span class="hs-comment">--   There are no special requirements.</span><span>
</span><a name="line-33"></a><span class="hs-comment">--</span><span>
</span><a name="line-34"></a><span class="hs-comment">--   == Translations</span><span>
</span><a name="line-35"></a><span class="hs-comment">--</span><span>
</span><a name="line-36"></a><span class="hs-comment">--   Every @let@-expression</span><span>
</span><a name="line-37"></a><span class="hs-comment">--</span><span>
</span><a name="line-38"></a><span class="hs-comment">--   &gt; let { x&#8321; = e&#8321;; &#8230;; x&#8345; = e&#8345; } in e</span><span>
</span><a name="line-39"></a><span class="hs-comment">--</span><span>
</span><a name="line-40"></a><span class="hs-comment">--   is transformed into a @let@-expression</span><span>
</span><a name="line-41"></a><span class="hs-comment">--</span><span>
</span><a name="line-42"></a><span class="hs-comment">--   &gt; let { y&#8321; = f&#8321;; &#8230;; y&#8345; = f&#8345; } in e</span><span>
</span><a name="line-43"></a><span class="hs-comment">--</span><span>
</span><a name="line-44"></a><span class="hs-comment">--   where @y&#8321; = f&#8321;, &#8230;, y&#8345; = f&#8345;@ is a permutation of @x&#8321; = e&#8321;, &#8230;, x&#8345; = e&#8345;@</span><span>
</span><a name="line-45"></a><span class="hs-comment">--   such that for every @1 &#8804; i &#8804; n@ the expression @f&#7522;@ contains no free</span><span>
</span><a name="line-46"></a><span class="hs-comment">--   variables @x&#11388;@ with @j &#8805; i@, i.e., all variables bound by the new</span><span>
</span><a name="line-47"></a><span class="hs-comment">--   @let@-expression are not used before they are declared. If there is no</span><span>
</span><a name="line-48"></a><span class="hs-comment">--   such permutation a fatal error is reported.</span><span>
</span><a name="line-49"></a><span class="hs-comment">--</span><span>
</span><a name="line-50"></a><span class="hs-comment">--   == Postcondition</span><span>
</span><a name="line-51"></a><span class="hs-comment">--</span><span>
</span><a name="line-52"></a><span class="hs-comment">--   The bindings of all @let@-expressions are in reverse topological order and</span><span>
</span><a name="line-53"></a><span class="hs-comment">--   there are no recursive or mutually recursive bindings.</span><span>
</span><a name="line-54"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">FreeC.Pass.LetSortPass</span><span>
</span><a name="line-55"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="FreeC.Pass.LetSortPass.html#letSortPass"><span class="hs-identifier hs-var">letSortPass</span></a><span>
</span><a name="line-56"></a><span>    </span><span class="hs-comment">-- * Testing Interface</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FreeC.Pass.LetSortPass.html#sortLetExprs"><span class="hs-identifier hs-var">sortLetExprs</span></a><span>
</span><a name="line-58"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span>           </span><a href="FreeC.IR.DependencyGraph.html"><span class="hs-identifier">FreeC.IR.DependencyGraph</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span>           </span><a href="FreeC.IR.SrcSpan.html"><span class="hs-identifier">FreeC.IR.SrcSpan</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span>           </span><a href="FreeC.IR.Subterm.html"><span class="hs-identifier">FreeC.IR.Subterm</span></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="FreeC.IR.Syntax.html"><span class="hs-identifier">FreeC.IR.Syntax</span></a><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IR</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span>           </span><a href="FreeC.Monad.Reporter.html"><span class="hs-identifier">FreeC.Monad.Reporter</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span>           </span><a href="FreeC.Pass.html"><span class="hs-identifier">FreeC.Pass</span></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span>           </span><a href="FreeC.Pretty.html"><span class="hs-identifier">FreeC.Pretty</span></a><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">-- | A pass that sorts the bindings of @let@-expressions topologically.</span><span>
</span><a name="line-69"></a><span class="hs-identifier">letSortPass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FreeC.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a><span> </span><a href="FreeC.IR.Syntax.Module.html#Module"><span class="hs-identifier hs-type">IR.Module</span></a><span> </span><a href="FreeC.IR.Syntax.Module.html#Module"><span class="hs-identifier hs-type">IR.Module</span></a><span>
</span><a name="line-70"></a><a name="letSortPass"><a href="FreeC.Pass.LetSortPass.html#letSortPass"><span class="hs-identifier">letSortPass</span></a></a><span> </span><a name="local-6989586621679228995"><a href="#local-6989586621679228995"><span class="hs-identifier">ast</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-71"></a><span>  </span><a name="local-6989586621679228996"><a href="#local-6989586621679228996"><span class="hs-identifier">funcDecls'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="FreeC.Pass.LetSortPass.html#sortFuncDecl"><span class="hs-identifier hs-var">sortFuncDecl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">IR.modFuncDecls</span><span> </span><a href="#local-6989586621679228995"><span class="hs-identifier hs-var">ast</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679228995"><span class="hs-identifier hs-var">ast</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">IR.modFuncDecls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679228996"><span class="hs-identifier hs-var">funcDecls'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-comment">-- | Sorts all @let@-expressions on the right-hand side of the given function</span><span>
</span><a name="line-75"></a><span class="hs-comment">--   declaration topologically.</span><span>
</span><a name="line-76"></a><span class="hs-identifier">sortFuncDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FreeC.Monad.Reporter.html#MonadReporter"><span class="hs-identifier hs-type">MonadReporter</span></a><span> </span><a href="#local-6989586621679228994"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="FreeC.IR.Syntax.FuncDecl.html#FuncDecl"><span class="hs-identifier hs-type">IR.FuncDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679228994"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="FreeC.IR.Syntax.FuncDecl.html#FuncDecl"><span class="hs-identifier hs-type">IR.FuncDecl</span></a><span>
</span><a name="line-77"></a><a name="sortFuncDecl"><a href="FreeC.Pass.LetSortPass.html#sortFuncDecl"><span class="hs-identifier">sortFuncDecl</span></a></a><span> </span><a name="local-6989586621679228997"><a href="#local-6989586621679228997"><span class="hs-identifier">funcDecl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-78"></a><span>  </span><a name="local-6989586621679228998"><a href="#local-6989586621679228998"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FreeC.Pass.LetSortPass.html#sortLetExprs"><span class="hs-identifier hs-var">sortLetExprs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">IR.funcDeclRhs</span><span> </span><a href="#local-6989586621679228997"><span class="hs-identifier hs-var">funcDecl</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679228997"><span class="hs-identifier hs-var">funcDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">IR.funcDeclRhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679228998"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-- | Sorts all @let@-expressions in the given expression topologically.</span><span>
</span><a name="line-82"></a><span class="hs-identifier">sortLetExprs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FreeC.Monad.Reporter.html#MonadReporter"><span class="hs-identifier hs-type">MonadReporter</span></a><span> </span><a href="#local-6989586621679228993"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="FreeC.IR.Syntax.Expr.html#Expr"><span class="hs-identifier hs-type">IR.Expr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679228993"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="FreeC.IR.Syntax.Expr.html#Expr"><span class="hs-identifier hs-type">IR.Expr</span></a><span>
</span><a name="line-83"></a><a name="sortLetExprs"><a href="FreeC.Pass.LetSortPass.html#sortLetExprs"><span class="hs-identifier">sortLetExprs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FreeC.IR.Subterm.html#mapSubtermsM"><span class="hs-identifier hs-var">mapSubtermsM</span></a><span> </span><a href="#local-6989586621679228999"><span class="hs-identifier hs-var">sortLet</span></a><span>
</span><a name="line-84"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-identifier">sortLet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FreeC.Monad.Reporter.html#MonadReporter"><span class="hs-identifier hs-type">MonadReporter</span></a><span> </span><a href="#local-6989586621679229001"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="FreeC.IR.Syntax.Expr.html#Expr"><span class="hs-identifier hs-type">IR.Expr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679229001"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="FreeC.IR.Syntax.Expr.html#Expr"><span class="hs-identifier hs-type">IR.Expr</span></a><span>
</span><a name="line-86"></a><span>  </span><a name="local-6989586621679228999"><a href="#local-6989586621679228999"><span class="hs-identifier">sortLet</span></a></a><span> </span><span class="hs-special">(</span><a href="FreeC.IR.Syntax.Expr.html#Let"><span class="hs-identifier hs-var">IR.Let</span></a><span> </span><a name="local-6989586621679229003"><a href="#local-6989586621679229003"><span class="hs-identifier">srcSpan</span></a></a><span> </span><a name="local-6989586621679229004"><a href="#local-6989586621679229004"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621679229005"><a href="#local-6989586621679229005"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621679229006"><a href="#local-6989586621679229006"><span class="hs-identifier">exprType</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-87"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679229007"><a href="#local-6989586621679229007"><span class="hs-identifier">components</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FreeC.IR.DependencyGraph.html#valueDependencyComponents"><span class="hs-identifier hs-var">valueDependencyComponents</span></a><span> </span><a href="#local-6989586621679229004"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-88"></a><span>    </span><a name="local-6989586621679229008"><a href="#local-6989586621679229008"><span class="hs-identifier">binds'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679229000"><span class="hs-identifier hs-var">fromNonRecursive</span></a><span> </span><a href="#local-6989586621679229003"><span class="hs-identifier hs-var">srcSpan</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679229007"><span class="hs-identifier hs-var">components</span></a><span>
</span><a name="line-89"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="FreeC.IR.Syntax.Expr.html#Let"><span class="hs-identifier hs-var">IR.Let</span></a><span> </span><a href="#local-6989586621679229003"><span class="hs-identifier hs-var">srcSpan</span></a><span> </span><a href="#local-6989586621679229008"><span class="hs-identifier hs-var">binds'</span></a><span> </span><a href="#local-6989586621679229005"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621679229006"><span class="hs-identifier hs-var">exprType</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>  </span><span class="hs-identifier">sortLet</span><span> </span><a name="local-6989586621679229009"><a href="#local-6989586621679229009"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679229009"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>  </span><span class="hs-comment">-- | Extracts the single non-recursive @let@-binding from the given strongly</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-comment">--   connected component of the dependency graph.</span><span>
</span><a name="line-94"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-95"></a><span>  </span><span class="hs-comment">--   Reports a fatal error with the given source span if the bindings in the</span><span>
</span><a name="line-96"></a><span>  </span><span class="hs-comment">--   component are recursive.</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-identifier">fromNonRecursive</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="FreeC.Monad.Reporter.html#MonadReporter"><span class="hs-identifier hs-type">MonadReporter</span></a><span> </span><a href="#local-6989586621679229002"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="FreeC.IR.SrcSpan.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FreeC.IR.DependencyGraph.html#DependencyComponent"><span class="hs-identifier hs-type">DependencyComponent</span></a><span> </span><a href="FreeC.IR.Syntax.Expr.html#Bind"><span class="hs-identifier hs-type">IR.Bind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679229002"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="FreeC.IR.Syntax.Expr.html#Bind"><span class="hs-identifier hs-type">IR.Bind</span></a><span>
</span><a name="line-99"></a><span>  </span><a name="local-6989586621679229000"><a href="#local-6989586621679229000"><span class="hs-identifier">fromNonRecursive</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="FreeC.IR.DependencyGraph.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a name="local-6989586621679229010"><a href="#local-6989586621679229010"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679229010"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-100"></a><span>  </span><span class="hs-identifier">fromNonRecursive</span><span> </span><a name="local-6989586621679229011"><a href="#local-6989586621679229011"><span class="hs-identifier">srcSpan</span></a></a><span> </span><span class="hs-special">(</span><a href="FreeC.IR.DependencyGraph.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a><span> </span><a name="local-6989586621679229012"><a href="#local-6989586621679229012"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FreeC.Monad.Reporter.html#reportFatal"><span class="hs-identifier hs-var">reportFatal</span></a><span>
</span><a name="line-101"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><a href="FreeC.Monad.Reporter.html#Message"><span class="hs-identifier hs-var">Message</span></a><span> </span><a href="#local-6989586621679229011"><span class="hs-identifier hs-var">srcSpan</span></a><span> </span><a href="FreeC.Monad.Reporter.html#Error"><span class="hs-identifier hs-var">Error</span></a><span>
</span><a name="line-102"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Recursive `let`-bindings are not supported but the bindings for &quot;</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><a href="FreeC.Pretty.html#showPretty"><span class="hs-identifier hs-var">showPretty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="FreeC.IR.Syntax.Name.html#declName"><span class="hs-identifier hs-var">IR.declName</span></a><span> </span><a href="#local-6989586621679229012"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; form a cycle.&quot;</span><span>
</span><a name="line-105"></a></pre></body></html>